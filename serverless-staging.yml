service: newrelic-log-ingestion
variablesResolutionMode: 20210326

provider:
  name: aws
  runtime: python3.9
  stage: staging
  region: us-east-2
  memorySize: 128  # ram in MB
  timeout: 60 # timeout in seconds
  lambdaHashingVersion: 20201221

  iam:
    role:
      name: staging-newrelic-logs-shipper
      path: /staging-common-services/
      managedPolicies:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      tags:
        Service: common-services
        Environment: staging
        Component: newrelic-logs-shipper

  environment:
    # Determines if logs are forwarded to New Relic Infrastructure
    INFRA_ENABLED: ${env:INFRA_ENABLED, "False"}
    # Your NewRelic license key
    LICENSE_KEY: ${ssm(us-west-2):/common/infra/NEWRELIC_LICENSE}
    # Determines if logs are forwarded to New Relic Logging
    LOGGING_ENABLED: ${env:LOGGING_ENABLED, "True"}
    # A boolean to determine if you want to output debug messages in the CloudWatch console
    DEBUG_LOGGING_ENABLED: ${env:DEBUG_LOGGING_ENABLED, "False"}

  deploymentBucket:
    name: flytrex-serverless-staging
    skipPolicySetup: true
  deploymentPrefix: newrelic-logs-shipper  # s3 bucket prefix appended to deployments

custom:
  pythonRequirements:
    dockerizePip: true
    dockerFile: ./Dockerfile

package:
  exclude:
    - ./**
  include:
    - ./LICENSE
    - ./src/function.py

functions:
  stagingNewrelicLogIngestion:
    description: Send log data from CloudWatch Logs to New Relic Infrastructure (Cloud Integrations) and New Relic Logging.
    handler: src/function.lambda_handler
    name: staging-newrelic-log-ingestion
    reservedConcurrency: 10 # optional, reserved concurrency limit for this function. By default, AWS uses account concurrency limit
    events:
      # staging gcs
      - cloudwatchLog: 'staging-delivery-service-dashboard-backend'
      - cloudwatchLog: 'staging-delivery-service-delivery-api'
      - cloudwatchLog: 'staging-delivery-service-mc-logger'
      - cloudwatchLog: 'staging-delivery-service-misc-services'
      - cloudwatchLog: 'staging-delivery-service-mission-manager'
      - cloudwatchLog: 'staging-delivery-service-oversight-middleman'
      - cloudwatchLog: 'staging-delivery-service-router'
      - cloudwatchLog: 'staging-delivery-service-seeder'
      - cloudwatchLog: 'staging-delivery-service-test-frontend'
      - cloudwatchLog: 'staging-delivery-service-vehicle-simulator'
      - cloudwatchLog: 'staging/ecs-init'
      - cloudwatchLog: 'staging/ecs-agent'
      # staging2 gcs
      - cloudwatchLog: 'staging2-delivery-service-dashboard-backend'
      - cloudwatchLog: 'staging2-delivery-service-delivery-api'
      - cloudwatchLog: 'staging2-delivery-service-mc-logger'
      - cloudwatchLog: 'staging2-delivery-service-misc-services'
      - cloudwatchLog: 'staging2-delivery-service-mission-manager'
      - cloudwatchLog: 'staging2-delivery-service-oversight-middleman'
      - cloudwatchLog: 'staging2-delivery-service-router'
      - cloudwatchLog: 'staging2-delivery-service-seeder'
      - cloudwatchLog: 'staging2-delivery-service-test-frontend'
      - cloudwatchLog: 'staging2-delivery-service-vehicle-simulator'
      - cloudwatchLog: 'staging2/ecs-init'
      - cloudwatchLog: 'staging2/ecs-agent'
      # staging3 gcs
      - cloudwatchLog: 'staging3-delivery-service-dashboard-backend'
      - cloudwatchLog: 'staging3-delivery-service-delivery-api'
      - cloudwatchLog: 'staging3-delivery-service-mc-logger'
      - cloudwatchLog: 'staging3-delivery-service-misc-services'
      - cloudwatchLog: 'staging3-delivery-service-mission-manager'
      - cloudwatchLog: 'staging3-delivery-service-oversight-middleman'
      - cloudwatchLog: 'staging3-delivery-service-router'
      - cloudwatchLog: 'staging3-delivery-service-seeder'
      - cloudwatchLog: 'staging3-delivery-service-test-frontend'
      - cloudwatchLog: 'staging3-delivery-service-vehicle-simulator'
      - cloudwatchLog: 'staging3/ecs-init'
      - cloudwatchLog: 'staging3/ecs-agent'
      # staging4 gcs
      - cloudwatchLog: 'staging4-delivery-service-dashboard-backend'
      - cloudwatchLog: 'staging4-delivery-service-delivery-api'
      - cloudwatchLog: 'staging4-delivery-service-mc-logger'
      - cloudwatchLog: 'staging4-delivery-service-misc-services'
      - cloudwatchLog: 'staging4-delivery-service-mission-manager'
      - cloudwatchLog: 'staging4-delivery-service-oversight-middleman'
      - cloudwatchLog: 'staging4-delivery-service-router'
      - cloudwatchLog: 'staging4-delivery-service-seeder'
      - cloudwatchLog: 'staging4-delivery-service-test-frontend'
      - cloudwatchLog: 'staging4-delivery-service-vehicle-simulator'
      - cloudwatchLog: 'staging4/ecs-init'
      - cloudwatchLog: 'staging4/ecs-agent'
      # staging-external gcs
      - cloudwatchLog: 'external-delivery-service-dashboard-backend'
      - cloudwatchLog: 'external-delivery-service-delivery-api'
      - cloudwatchLog: 'external-delivery-service-mc-logger'
      - cloudwatchLog: 'external-delivery-service-misc-services'
      - cloudwatchLog: 'external-delivery-service-mission-manager'
      - cloudwatchLog: 'external-delivery-service-oversight-middleman'
      - cloudwatchLog: 'external-delivery-service-router'
      - cloudwatchLog: 'external-delivery-service-seeder'
      - cloudwatchLog: 'external-delivery-service-test-frontend'
      - cloudwatchLog: 'external-delivery-service-vehicle-simulator'
      - cloudwatchLog: 'external/ecs-init'
      - cloudwatchLog: 'external/ecs-agent'
      # staging-papa gcs
      - cloudwatchLog: 'staging-papa-delivery-service-dashboard-backend'
      - cloudwatchLog: 'staging-papa-delivery-service-delivery-api'
      - cloudwatchLog: 'staging-papa-delivery-service-mc-logger'
      - cloudwatchLog: 'staging-papa-delivery-service-misc-services'
      - cloudwatchLog: 'staging-papa-delivery-service-mission-manager'
      - cloudwatchLog: 'staging-papa-delivery-service-oversight-middleman'
      - cloudwatchLog: 'staging-papa-delivery-service-router'
      - cloudwatchLog: 'staging-papa-delivery-service-seeder'
      - cloudwatchLog: 'staging-papa-delivery-service-test-frontend'
      - cloudwatchLog: 'staging-papa-delivery-service-vehicle-simulator'
      - cloudwatchLog: 'staging-papa/ecs-init'
      - cloudwatchLog: 'staging-papa/ecs-agent'
      # regulation gcs
      - cloudwatchLog: 'regulation-delivery-service-dashboard-backend'
      - cloudwatchLog: 'regulation-delivery-service-delivery-api'
      - cloudwatchLog: 'regulation-delivery-service-mc-logger'
      - cloudwatchLog: 'regulation-delivery-service-misc-services'
      - cloudwatchLog: 'regulation-delivery-service-mission-manager'
      - cloudwatchLog: 'regulation-delivery-service-oversight-middleman'
      - cloudwatchLog: 'regulation-delivery-service-router'
      - cloudwatchLog: 'regulation-delivery-service-seeder'
      - cloudwatchLog: 'regulation-delivery-service-test-frontend'
      - cloudwatchLog: 'regulation-delivery-service-vehicle-simulator'
      - cloudwatchLog: 'regulation/ecs-init'
      - cloudwatchLog: 'regulation/ecs-agent'
      # regulationdev gcs
      - cloudwatchLog: 'regulationdev-delivery-service-dashboard-backend'
      - cloudwatchLog: 'regulationdev-delivery-service-delivery-api'
      - cloudwatchLog: 'regulationdev-delivery-service-mc-logger'
      - cloudwatchLog: 'regulationdev-delivery-service-misc-services'
      - cloudwatchLog: 'regulationdev-delivery-service-mission-manager'
      - cloudwatchLog: 'regulationdev-delivery-service-oversight-middleman'
      - cloudwatchLog: 'regulationdev-delivery-service-router'
      - cloudwatchLog: 'regulationdev-delivery-service-seeder'
      - cloudwatchLog: 'regulationdev-delivery-service-test-frontend'
      - cloudwatchLog: 'regulationdev-delivery-service-vehicle-simulator'
      - cloudwatchLog: 'regulationdev/ecs-init'
      - cloudwatchLog: 'regulationdev/ecs-agent'
      # productdemo gcs
      - cloudwatchLog: 'productdemo-delivery-service-dashboard-backend'
      - cloudwatchLog: 'productdemo-delivery-service-delivery-api'
      - cloudwatchLog: 'productdemo-delivery-service-mc-logger'
      - cloudwatchLog: 'productdemo-delivery-service-misc-services'
      - cloudwatchLog: 'productdemo-delivery-service-mission-manager'
      - cloudwatchLog: 'productdemo-delivery-service-oversight-middleman'
      - cloudwatchLog: 'productdemo-delivery-service-router'
      - cloudwatchLog: 'productdemo-delivery-service-seeder'
      - cloudwatchLog: 'productdemo-delivery-service-test-frontend'
      - cloudwatchLog: 'productdemo-delivery-service-vehicle-simulator'
      - cloudwatchLog: 'productdemo/ecs-init'
      - cloudwatchLog: 'productdemo/ecs-agent'
      # qa gcs
      - cloudwatchLog: 'qa-delivery-service-dashboard-backend'
      - cloudwatchLog: 'qa-delivery-service-delivery-api'
      - cloudwatchLog: 'qa-delivery-service-mc-logger'
      - cloudwatchLog: 'qa-delivery-service-misc-services'
      - cloudwatchLog: 'qa-delivery-service-mission-manager'
      - cloudwatchLog: 'qa-delivery-service-oversight-middleman'
      - cloudwatchLog: 'qa-delivery-service-router'
      - cloudwatchLog: 'qa-delivery-service-seeder'
      - cloudwatchLog: 'qa-delivery-service-test-frontend'
      - cloudwatchLog: 'qa-delivery-service-vehicle-simulator'
      - cloudwatchLog: 'qa/ecs-init'
      - cloudwatchLog: 'qa/ecs-agent'
      # papa gcs
      - cloudwatchLog: 'staging-papa-delivery-service-dashboard-backend'
      - cloudwatchLog: 'staging-papa-delivery-service-delivery-api'
      - cloudwatchLog: 'staging-papa-delivery-service-mc-logger'
      - cloudwatchLog: 'staging-papa-delivery-service-misc-services'
      - cloudwatchLog: 'staging-papa-delivery-service-mission-manager'
      - cloudwatchLog: 'staging-papa-delivery-service-oversight-middleman'
      - cloudwatchLog: 'staging-papa-delivery-service-router'
      - cloudwatchLog: 'staging-papa-delivery-service-seeder'
      - cloudwatchLog: 'staging-papa-delivery-service-test-frontend'
      - cloudwatchLog: 'staging-papa-delivery-service-vehicle-simulator'
      - cloudwatchLog: 'staging-papa/ecs-init'
      - cloudwatchLog: 'staging-papa/ecs-agent'
      # external gcs
      - cloudwatchLog: 'external-delivery-service-dashboard-backend'
      - cloudwatchLog: 'external-delivery-service-delivery-api'
      - cloudwatchLog: 'external-delivery-service-mc-logger'
      - cloudwatchLog: 'external-delivery-service-misc-services'
      - cloudwatchLog: 'external-delivery-service-mission-manager'
      - cloudwatchLog: 'external-delivery-service-oversight-middleman'
      - cloudwatchLog: 'external-delivery-service-router'
      - cloudwatchLog: 'external-delivery-service-seeder'
      - cloudwatchLog: 'external-delivery-service-test-frontend'
      - cloudwatchLog: 'external-delivery-service-vehicle-simulator'
      - cloudwatchLog: 'external/ecs-init'
      - cloudwatchLog: 'external/ecs-agent'
      # oversight staging
      - cloudwatchLog: 'oversight/staging/ecs-agent'
      - cloudwatchLog: 'oversight/staging/ecs-init'
      - cloudwatchLog: 'staging-oversight-dashboard-backend'
      - cloudwatchLog: 'staging-oversight-seeder'
      - cloudwatchLog: 'staging-oversight-test-frontend'
      - cloudwatchLog: 'staging-oversight-vehicle-manager'
      # oversight staging qa
      - cloudwatchLog: 'oversight/qa/ecs-agent'
      - cloudwatchLog: 'oversight/qa/ecs-init'
      - cloudwatchLog: 'qa-oversight-dashboard-backend'
      - cloudwatchLog: 'qa-oversight-seeder'
      - cloudwatchLog: 'qa-oversight-test-frontend'
      - cloudwatchLog: 'qa-oversight-vehicle-manager'
      # foa service staging
      - cloudwatchLog: '/foa-service/staging/ecs-agent'
      - cloudwatchLog: 'staging-foa-service-seeder'
      - cloudwatchLog: 'staging-foa-service-admin'
      - cloudwatchLog: 'staging-foa-service-foa-backend'
      - cloudwatchLog: 'staging-foa-service-order-manager'
      - cloudwatchLog: 'staging-foa-service-misc'
      # foa service staging-qa
      - cloudwatchLog: '/foa-service/staging/ecs-agent'
      - cloudwatchLog: 'qa-foa-service-seeder'
      - cloudwatchLog: 'qa-foa-service-admin'
      - cloudwatchLog: 'qa-foa-service-foa-backend'
      - cloudwatchLog: 'qa-foa-service-order-manager'
      - cloudwatchLog: 'qa-foa-service-misc'
      # beehive
      - cloudwatchLog: 'beehive-sitl-staging'
      # queue service staging
      - cloudwatchLog: '/queue-service/staging/ecs-agent'
      - cloudwatchLog: '/queue-service/staging/ecs-init'
      - cloudwatchLog: 'staging-queue-service-seeder'
      - cloudwatchLog: 'staging-queue-service-admin'
      - cloudwatchLog: 'staging-queue-service-connection-manager'
      - cloudwatchLog: 'staging-queue-service-runner-manager'
      - cloudwatchLog: 'staging-queue-service-merchant-manager'
      # queue service staging-external
      - cloudwatchLog: '/queue-service/external/ecs-agent'
      - cloudwatchLog: '/queue-service/external/ecs-init'
      - cloudwatchLog: 'external-queue-service-seeder'
      - cloudwatchLog: 'external-queue-service-admin'
      - cloudwatchLog: 'external-queue-service-connection-manager'
      - cloudwatchLog: 'external-queue-service-runner-manager'
#      - cloudwatchLog: 'external-queue-service-merchant-manager'
      # queue service staging-papa
      - cloudwatchLog: '/queue-service/papa/ecs-agent'
      - cloudwatchLog: '/queue-service/papa/ecs-init'
      - cloudwatchLog: 'papa-queue-service-seeder'
      - cloudwatchLog: 'papa-queue-service-admin'
      - cloudwatchLog: 'papa-queue-service-connection-manager'
      - cloudwatchLog: 'papa-queue-service-runner-manager'
#      - cloudwatchLog: 'papa-queue-service-merchant-manager'
      # queue service qa
      - cloudwatchLog: '/queue-service/qa/ecs-agent'
      - cloudwatchLog: '/queue-service/qa/ecs-init'
      - cloudwatchLog: 'qa-queue-service-seeder'
      - cloudwatchLog: 'qa-queue-service-admin'
      - cloudwatchLog: 'qa-queue-service-connection-manager'
      - cloudwatchLog: 'qa-queue-service-runner-manager'
      - cloudwatchLog: 'qa-queue-service-merchant-manager'
      # bigquery etl lambdas
      - cloudwatchLog: '/aws/lambda/etl-db-to-bigquery-staging-uploadParquetToBigquery'
      - cloudwatchLog: '/aws/lambda/etl-db-to-bigquery-staging-dumpDb'
      - cloudwatchLog: '/aws/lambda/etl-db-to-bigquery-staging-sqlToParquet'
      - cloudwatchLog: '/aws/lambda/etl-db-to-bigquery-staging-initiator'
      - cloudwatchLog: '/aws/lambda/etl-db-to-bigquery-staging-latestPartitionViews'
      - cloudwatchLog: '/aws/lambda/etl-db-to-bigquery-staging-sendMail'
      - cloudwatchLog: '/aws/lambda/etl-db-to-bigquery-staging-errorToDynamoDB'
      - cloudwatchLog: '/aws/lambda/etl-db-to-bigquery-staging-telemetryToParquet'
      - cloudwatchLog: '/aws/lambda/etl-db-to-bigquery-staging-telemetryToBigQuery'

plugins:
  - serverless-python-requirements
